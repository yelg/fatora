import{a6 as Y,u as j,s as E,a3 as L,aI as Z,a9 as ee,v as z,N as te,O as Q,G as F,a7 as se,r as g,K as C,o as y,w as u,L as O,l as d,a as f,q as k,t as v,e as U,j as V,f as P,g as J,J as ae,i as oe,b as h,m as ne,c as D,Q as q,R as K,M as X,F as ie,a8 as le}from"./main-DnObvGgc.js";const T=(I=!1)=>{const p=I?window.pinia.defineStore:Y,{global:e}=window.i18n;return p({id:"role",state:()=>({roles:[],allAbilities:[],selectedRoles:[],currentRole:{id:null,name:"",abilities:[]}}),getters:{isEdit:a=>!!a.currentRole.id,abilitiesList:a=>{let n=a.allAbilities.map(i=>({modelName:i.model?i.model.substring(i.model.lastIndexOf("\\")+1):"Common",disabled:!1,...i}));return Z.groupBy(n,"modelName")}},actions:{fetchRoles(a){return new Promise((n,i)=>{E.get("/api/v1/roles",{params:a}).then(t=>{this.roles=t.data.data,n(t)}).catch(t=>{L(t),i(t)})})},fetchRole(a){return new Promise((n,i)=>{E.get(`/api/v1/roles/${a}`).then(t=>{this.currentRole.name=t.data.data.name,this.currentRole.id=t.data.data.id,t.data.data.abilities.forEach(l=>{for(const c in this.abilitiesList)this.abilitiesList[c].forEach(_=>{_.ability===l.name&&this.currentRole.abilities.push(_)})}),n(t)}).catch(t=>{L(t),i(t)})})},addRole(a){const n=j();return new Promise((i,t)=>{E.post("/api/v1/roles",a).then(l=>{this.roles.push(l.data.role),n.showNotification({type:"success",message:e.t("settings.roles.created_message")}),i(l)}).catch(l=>{L(l),t(l)})})},updateRole(a){const n=j();return new Promise((i,t)=>{E.put(`/api/v1/roles/${a.id}`,a).then(l=>{if(l.data){let c=this.roles.findIndex(_=>_.id===l.data.data.id);this.roles[c]=a.role,n.showNotification({type:"success",message:e.t("settings.roles.updated_message")})}i(l)}).catch(l=>{L(l),t(l)})})},fetchAbilities(a){return new Promise((n,i)=>{this.allAbilities.length?n(this.allAbilities):E.get("/api/v1/abilities",{params:a}).then(t=>{this.allAbilities=t.data.abilities,n(t)}).catch(t=>{L(t),i(t)})})},deleteRole(a){const n=j();return new Promise((i,t)=>{E.delete(`/api/v1/roles/${a}`).then(l=>{let c=this.roles.findIndex(_=>_.id===a);this.roles.splice(c,1),n.showNotification({type:"success",message:e.t("settings.roles.deleted_message")}),i(l)}).catch(l=>{L(l),t(l)})})}}})()},re={__name:"RoleIndexDropdown",props:{row:{type:Object,default:null},table:{type:Object,default:null},loadData:{type:Function,default:null}},setup(I){const p=I,e=ee();j();const{t:a}=z.useI18n(),n=T(),i=te(),t=Q(),l=F();se("utils");async function c(R){Promise.all([await n.fetchAbilities(),await n.fetchRole(R)]).then(()=>{l.openModal({title:a("settings.roles.edit_role"),componentName:"RolesModal",size:"lg",refreshData:p.loadData})})}async function _(R){e.openDialog({title:a("general.are_you_sure"),message:a("settings.roles.confirm_delete"),yesLabel:a("general.ok"),noLabel:a("general.cancel"),variant:"danger",hideNoButton:!1,size:"lg"}).then(async b=>{b&&await n.deleteRole(R).then(x=>{x.data&&p.loadData&&p.loadData()})})}return(R,b)=>{const x=g("BaseIcon"),w=g("BaseButton"),s=g("BaseDropdownItem"),o=g("BaseDropdown");return y(),C(o,null,{activator:u(()=>[d(i).name==="roles.view"?(y(),C(w,{key:0,variant:"primary"},{default:u(()=>[f(x,{name:"EllipsisHorizontalIcon",class:"h-5 text-white"})]),_:1})):(y(),C(x,{key:1,name:"EllipsisHorizontalIcon",class:"h-5 text-gray-500"}))]),default:u(()=>[d(t).currentUser.is_owner?(y(),C(s,{key:0,onClick:b[0]||(b[0]=m=>c(I.row.id))},{default:u(()=>[f(x,{name:"PencilIcon",class:"w-5 h-5 mr-3 text-gray-400 group-hover:text-gray-500"}),k(" "+v(R.$t("general.edit")),1)]),_:1})):O("",!0),d(t).currentUser.is_owner?(y(),C(s,{key:1,onClick:b[1]||(b[1]=m=>_(I.row.id))},{default:u(()=>[f(x,{name:"TrashIcon",class:"w-5 h-5 mr-3 text-gray-400 group-hover:text-gray-500"}),k(" "+v(R.$t("general.delete")),1)]),_:1})):O("",!0)]),_:1})}}},de={class:"flex justify-between w-full"},ce={class:"px-4 md:px-8 py-4 md:py-6"},ue={class:"flex justify-between"},me={class:"text-sm not-italic font-medium text-gray-800 px-4 md:px-8 py-1.5"},fe={class:"text-sm not-italic font-medium text-gray-300 px-4 md:px-8 py-1.5"},pe={class:"border-t border-gray-200 py-3"},be={class:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 px-8 sm:px-8"},ge={class:"text-sm text-gray-500 border-b border-gray-200 pb-1 mb-2"},he={key:0,class:"block mt-0.5 text-sm text-red-500"},ye={class:"z-0 flex justify-end p-4 border-t border-solid border--200 border-modal-bg"},_e={__name:"RolesModal",setup(I){const p=F(),e=T(),{t:a}=z.useI18n();let n=U(!1),i=U(!1);const t=V(()=>p.active&&p.componentName==="RolesModal"),l=V(()=>({name:{required:P.withMessage(a("validation.required"),J),minLength:P.withMessage(a("validation.name_min_length",{count:3}),ae(3))},abilities:{required:P.withMessage(a("validation.at_least_one_ability"),J)}})),c=oe(l,V(()=>e.currentRole));async function _(){if(c.value.$touch(),c.value.$invalid)return!0;try{const s=e.isEdit?e.updateRole:e.addRole;n.value=!0,await s(e.currentRole),n.value=!1,p.refreshData&&p.refreshData(),w()}catch{return n.value=!1,!0}}function R(s){var m,r;if(!e.currentRole.abilities.find(S=>S.ability===s.ability)&&((m=s==null?void 0:s.depends_on)!=null&&m.length)){x(s);return}(r=s==null?void 0:s.depends_on)==null||r.forEach(S=>{Object.keys(e.abilitiesList).forEach(M=>{e.abilitiesList[M].forEach($=>{S===$.ability&&($.disabled=!0,e.currentRole.abilities.find(B=>B.ability===S)||e.currentRole.abilities.push($))})})})}function b(s){let o=[];Object.keys(e.abilitiesList).forEach(m=>{e.abilitiesList[m].forEach(r=>{r!=null&&r.depends_on&&(o=[...o,...r.depends_on])})}),Object.keys(e.abilitiesList).forEach(m=>{e.abilitiesList[m].forEach(r=>{o.includes(r.ability)&&(s?r.disabled=!0:r.disabled=!1),e.currentRole.abilities.push(r)})}),s||(e.currentRole.abilities=[])}function x(s){s.depends_on.forEach(o=>{Object.keys(e.abilitiesList).forEach(m=>{e.abilitiesList[m].forEach(r=>{let S=e.currentRole.abilities.find(M=>{var $;return($=M.depends_on)==null?void 0:$.includes(r.ability)});o===r.ability&&!S&&(r.disabled=!1)})})})}function w(){p.closeModal(),setTimeout(()=>{e.currentRole={id:null,name:"",abilities:[]},Object.keys(e.abilitiesList).forEach(s=>{e.abilitiesList[s].forEach(o=>{o.disabled=!1})}),c.value.$reset()},300)}return(s,o)=>{const m=g("BaseIcon"),r=g("BaseInput"),S=g("BaseInputGroup"),M=g("BaseCheckbox"),$=g("BaseButton"),G=g("BaseModal");return y(),C(G,{show:t.value,onClose:w},{header:u(()=>[h("div",de,[k(v(d(p).title)+" ",1),f(m,{name:"XMarkIcon",class:"w-6 h-6 text-gray-500 cursor-pointer",onClick:w})])]),default:u(()=>[h("form",{onSubmit:ne(_,["prevent"])},[h("div",ce,[f(S,{label:s.$t("settings.roles.name"),class:"mt-3",error:d(c).name.$error&&d(c).name.$errors[0].$message,required:"","content-loading":d(i)},{default:u(()=>[f(r,{modelValue:d(e).currentRole.name,"onUpdate:modelValue":o[0]||(o[0]=B=>d(e).currentRole.name=B),invalid:d(c).name.$error,type:"text","content-loading":d(i),onInput:o[1]||(o[1]=B=>d(c).name.$touch())},null,8,["modelValue","invalid","content-loading"])]),_:1},8,["label","error","content-loading"])]),h("div",ue,[h("h6",me,[k(v(s.$t("settings.roles.permission",2))+" ",1),o[5]||(o[5]=h("span",{class:"text-sm text-red-500"}," *",-1))]),h("div",fe,[h("a",{class:"cursor-pointer text-primary-400",onClick:o[2]||(o[2]=B=>b(!0))},v(s.$t("settings.roles.select_all")),1),o[6]||(o[6]=k(" / ")),h("a",{class:"cursor-pointer text-primary-400",onClick:o[3]||(o[3]=B=>b(!1))},v(s.$t("settings.roles.none")),1)])]),h("div",pe,[h("div",be,[(y(!0),D(q,null,K(d(e).abilitiesList,(B,A)=>(y(),D("div",{key:A,class:"flex flex-col space-y-1"},[h("p",ge,v(A),1),(y(!0),D(q,null,K(B,(N,W)=>(y(),D("div",{key:W,class:"flex"},[f(M,{modelValue:d(e).currentRole.abilities,"onUpdate:modelValue":[o[4]||(o[4]=H=>d(e).currentRole.abilities=H),H=>R(N)],"set-initial-value":!0,variant:"primary",disabled:N.disabled,label:N.name,value:N},null,8,["modelValue","disabled","label","value","onUpdate:modelValue"])]))),128))]))),128)),d(c).abilities.$error?(y(),D("span",he,v(d(c).abilities.$errors[0].$message),1)):O("",!0)])]),h("div",ye,[f($,{class:"mr-3 text-sm",variant:"primary-outline",type:"button",onClick:w},{default:u(()=>[k(v(s.$t("general.cancel")),1)]),_:1}),f($,{loading:d(n),disabled:d(n),variant:"primary",type:"submit"},{left:u(B=>[f(m,{name:"ArrowDownOnSquareIcon",class:X(B.class)},null,8,["class"])]),default:u(()=>[k(" "+v(d(e).isEdit?s.$t("general.update"):s.$t("general.save")),1)]),_:1},8,["loading","disabled"])])],32)]),_:1},8,["show"])}}},we={__name:"RolesSettings",setup(I){const p=F(),e=T(),a=Q(),n=ie(),{t:i}=z.useI18n(),t=U(null),l=V(()=>[{key:"name",label:i("settings.roles.role_name"),thClass:"extra",tdClass:"font-medium text-gray-900"},{key:"created_at",label:i("settings.roles.added_on"),tdClass:"font-medium text-gray-900"},{key:"actions",label:"",tdClass:"text-right text-sm font-medium",sortable:!1}]);async function c({page:b,filter:x,sort:w}){let s={orderByField:w.fieldName||"created_at",orderBy:w.order||"desc",company_id:n.selectedCompany.id};return{data:(await e.fetchRoles(s)).data.data}}async function _(){t.value&&t.value.refresh()}async function R(){await e.fetchAbilities(),p.openModal({title:i("settings.roles.add_role"),componentName:"RolesModal",size:"lg",refreshData:t.value&&t.value.refresh})}return(b,x)=>{const w=g("BaseIcon"),s=g("BaseButton"),o=g("BaseTable"),m=g("BaseSettingCard");return y(),D(q,null,[f(_e),f(m,{title:b.$t("settings.roles.title"),description:b.$t("settings.roles.description")},le({default:u(()=>[f(o,{ref_key:"table",ref:t,data:c,columns:l.value,class:"mt-14"},{"cell-created_at":u(({row:r})=>[k(v(r.data.formatted_created_at),1)]),"cell-actions":u(({row:r})=>[d(a).currentUser.is_owner&&r.data.name!=="super admin"?(y(),C(re,{key:0,row:r.data,table:t.value,"load-data":_},null,8,["row","table"])):O("",!0)]),_:1},8,["columns"])]),_:2},[d(a).currentUser.is_owner?{name:"action",fn:u(()=>[f(s,{variant:"primary-outline",onClick:R},{left:u(r=>[f(w,{name:"PlusIcon",class:X(r.class)},null,8,["class"])]),default:u(()=>[k(" "+v(b.$t("settings.roles.add_new_role")),1)]),_:1})]),key:"0"}:void 0]),1032,["title","description"])],64)}}};export{we as default};
