import{u as Q,a9 as Y,v as G,F as J,e as r,I as T,s as L,j as W,K as D,w as k,r as y,o as n,b as t,a as _,L as c,ae as X,c as l,t as a,l as s,aH as Z,p as ee,q as N,Q as H,R as M,af as te,M as ae,a3 as q}from"./main-DnObvGgc.js";import{L as se}from"./LoadingIcon-UlwLbdlO.js";import{u as ne}from"./exchange-rate-C4tOL1sk.js";const le={class:"pb-8 ml-0"},ie={class:"text-sm not-italic font-medium input-label"},re={class:"w-full border-b-2 border-gray-100 border-solid pb-4"},oe={class:"box-border inline-block w-auto p-3 my-2 text-sm text-gray-600 bg-gray-200 border border-gray-200 border-solid rounded-md version"},de={class:"w-full pt-4"},pe={key:1,class:"mt-4 content"},ue={class:"rounded-md bg-primary-50 p-4 mb-3"},ce={class:"flex"},me={class:"shrink-0"},ge={class:"ml-3"},_e={class:"text-sm font-medium text-primary-800"},fe={class:"mt-2 text-sm text-primary-700"},he={class:"text-sm not-italic font-medium input-label"},ve={class:"box-border inline-block w-auto p-3 my-2 text-sm text-gray-600 bg-gray-200 border border-gray-200 border-solid rounded-md version"},be=["innerHTML"],ye=["innerHTML"],xe={class:"text-sm not-italic font-medium input-label"},we={class:"w-1/2 mt-2 border-2 border-gray-200 BaseTable-fixed"},ke={width:"70%",class:"p-2 text-sm truncate"},Be={width:"30%",class:"p-2 text-sm text-right"},Ue={key:0,class:"inline-block w-4 h-4 ml-3 mr-2 bg-green-500 rounded-full"},Se={key:1,class:"inline-block w-4 h-4 ml-3 mr-2 bg-red-500 rounded-full"},$e={key:2,class:"relative flex justify-between mt-4 content"},Ce={class:"m-0 mb-3 font-medium sw-section-title"},Le={class:"mb-8 text-sm leading-snug text-gray-500",style:{"max-width":"480px"}},Ne={key:3,class:"w-full p-0 list-none"},Ke={class:"m-0 text-sm leading-8"},Ve={class:"flex flex-row items-center"},Ie={key:0,class:"mr-3 text-xs text-gray-500"},Ee={__name:"UpdateAppSetting",setup(Te){const B=Q(),E=Y(),{t:u,tm:De}=G.useI18n();J(),ne();let x=r(!1),f=r(!1),U=r(""),S=r(""),$=r(""),m=r(""),h=r(null),j=r(null),p=r(!1);const C=T([{translationKey:"settings.update_app.download_zip_file",stepUrl:"/api/v1/update/download",time:null,started:!1,completed:!1},{translationKey:"settings.update_app.unzipping_package",stepUrl:"/api/v1/update/unzip",time:null,started:!1,completed:!1},{translationKey:"settings.update_app.copying_files",stepUrl:"/api/v1/update/copy",time:null,started:!1,completed:!1},{translationKey:"settings.update_app.deleting_files",stepUrl:"/api/v1/update/delete",time:null,started:!1,completed:!1},{translationKey:"settings.update_app.running_migrations",stepUrl:"/api/v1/update/migrate",time:null,started:!1,completed:!1},{translationKey:"settings.update_app.finishing_update",stepUrl:"/api/v1/update/finish",time:null,started:!1,completed:!1}]),w=T({isMinor:Boolean,installed:"",version:""});let z=r(null);window.addEventListener("beforeunload",e=>{p.value&&(e.returnValue="Update is in progress!")}),L.get("/api/v1/app/version").then(e=>{$.value=e.data.version,m.value=e.data.channel==="insider"});const F=W(()=>h.value!==null?Object.keys(h.value).every(e=>h.value[e]):!0);function R(e){switch(V(e)){case"pending":return"text-primary-800 bg-gray-200";case"finished":return"text-teal-500 bg-teal-100";case"running":return"text-blue-400 bg-blue-100";case"error":return"text-danger bg-red-200";default:return""}}async function A(){try{f.value=!0;let e=await L.get("/api/v1/check/update",{params:{channel:m?"insider":""}});if(f.value=!1,!e.data.release){B.showNotification({title:"Info!",type:"info",message:u("settings.update_app.latest_message")});return}e.data&&(w.isMinor=e.data.is_minor,w.version=e.data.release.version,U.value=e.data.release.description,S.value=e.data.release.changelog,h.value=e.data.release.extensions,x.value=!0,z.value=e.data.release.min_php_version,j.value=e.data.release.deleted_files)}catch(e){x.value=!1,f.value=!1,q(e)}}function K(){E.openDialog({title:u("general.are_you_sure"),message:u("settings.update_app.update_warning"),yesLabel:u("general.ok"),noLabel:u("general.cancel"),variant:"danger",hideNoButton:!1,size:"lg"}).then(async e=>{if(e){let o=null;if(!F.value)return B.showNotification({type:"error",message:"Your current configuration does not match the update requirements. Please try again after all the requirements are fulfilled."}),!0;for(let g=0;g<C.length;g++){let d=C[g];try{p.value=!0,d.started=!0;let v={version:w.version,installed:$.value,path:o||null},b=await L.post(d.stepUrl,v);d.completed=!0,b.data&&b.data.path&&(o=b.data.path),d.translationKey=="settings.update_app.finishing_update"&&(p.value=!1,B.showNotification({type:"success",message:u("settings.update_app.update_success")}),setTimeout(()=>{location.reload()},3e3))}catch(v){return d.started=!1,d.completed=!0,q(v),P(d.translationKey),!1}}}})}function P(e){if(u(e).value){K();return}p.value=!1}function V(e){return e.started&&e.completed?"finished":e.started&&!e.completed?"running":!e.started&&!e.completed?"pending":"error"}return(e,o)=>{const g=y("BaseButton"),d=y("BaseDivider"),v=y("BaseHeading"),b=y("BaseIcon"),O=y("BaseSettingCard");return n(),D(O,{title:e.$t("settings.update_app.title"),description:e.$t("settings.update_app.description")},{default:k(()=>[t("div",le,[t("label",ie,a(e.$t("settings.update_app.current_version")),1),t("div",re,[t("div",oe,a(s($)),1)]),t("div",de,[_(Z,{modelValue:s(m),"onUpdate:modelValue":o[0]||(o[0]=i=>ee(m)?m.value=i:m=i),label:e.$t("settings.update_app.insider_consent")},null,8,["modelValue","label"])]),_(g,{loading:s(f),disabled:s(f)||s(p),variant:"primary-outline",class:"mt-6",onClick:A},{default:k(()=>[N(a(e.$t("settings.update_app.check_update")),1)]),_:1},8,["loading","disabled"]),s(x)?(n(),D(d,{key:0,class:"mt-6 mb-4"})):c("",!0),s(x)?X((n(),l("div",pe,[_(v,{type:"heading-title",class:"mb-2"},{default:k(()=>[N(a(e.$t("settings.update_app.avail_update")),1)]),_:1}),t("div",ue,[t("div",ce,[t("div",me,[_(b,{name:"InformationCircleIcon",class:"h-5 w-5 text-primary-400","aria-hidden":"true"})]),t("div",ge,[t("h3",_e,a(e.$t("general.note")),1),t("div",fe,[t("p",null,a(e.$t("settings.update_app.update_warning")),1)])])])]),t("label",he,a(e.$t("settings.update_app.next_version")),1),o[1]||(o[1]=t("br",null,null,-1)),t("div",ve,a(w.version),1),s(U)?(n(),l("div",{key:0,class:"pl-5 mt-4 mb-2 text-sm leading-snug text-gray-500 update-description",style:{"white-space":"pre-wrap","max-width":"480px"},innerHTML:s(U)},null,8,be)):c("",!0),s(S)?(n(),l("div",{key:1,class:"pl-5 mt-2 mb-8 text-sm leading-snug text-gray-500 update-changelog",style:{"white-space":"pre-wrap","max-width":"480px"},innerHTML:s(S)},null,8,ye)):c("",!0),t("label",xe,a(e.$t("settings.update_app.requirements")),1),t("table",we,[(n(!0),l(H,null,M(s(h),(i,I)=>(n(),l("tr",{key:I,class:"p-2 border-2 border-gray-200"},[t("td",ke,a(I),1),t("td",Be,[i?(n(),l("span",Ue)):(n(),l("span",Se))])]))),128))]),_(g,{class:"mt-10",variant:"primary",onClick:K},{default:k(()=>[N(a(e.$t("settings.update_app.update")),1)]),_:1})],512)),[[te,!s(p)]]):c("",!0),s(p)?(n(),l("div",$e,[t("div",null,[t("h6",Ce,a(e.$t("settings.update_app.update_progress")),1),t("p",Le,a(e.$t("settings.update_app.progress_text")),1)]),_(se,{class:"absolute right-0 h-6 m-1 animate-spin text-primary-400"})])):c("",!0),s(p)?(n(),l("ul",Ne,[(n(!0),l(H,null,M(C,i=>(n(),l("li",{key:i.stepUrl,class:"flex justify-between w-full py-3 border-b border-gray-200 border-solid last:border-b-0"},[t("p",Ke,a(e.$t(i.translationKey)),1),t("div",Ve,[i.time?(n(),l("span",Ie,a(i.time),1)):c("",!0),t("span",{class:ae([R(i),"block py-1 text-sm text-center uppercase rounded-full"]),style:{width:"88px"}},a(V(i)),3)])]))),128))])):c("",!0)])]),_:1},8,["title","description"])}}};export{Ee as default};
